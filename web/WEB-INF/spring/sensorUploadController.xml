<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.5.xsd
                           http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util-2.5.xsd">
  <!--  
     Spring ApplicationContext configuration for sensor (phone) data upload 
  -->
  
  <!-- Servlet-to-AW hooks -->
  <!-- create AwRequest from data in the HttpServletRequest -->
  <bean id="sensorUploadAwRequestCreator" class="edu.ucla.cens.awserver.jee.servlet.glue.SensorUploadAwRequestCreator" />
  
  <!-- Controller - main workflow -->
  <bean id="sensorUploadController" class="edu.ucla.cens.awserver.controller.ControllerImpl">
    <constructor-arg index="0">
    <!-- service the upload request -->
      <list>
        <ref bean="sensorUploadAuthenticationService" />
        <ref bean="jsonMessageSyntaxValidationService" />
        <ref bean="jsonMessageContentValidationService" />
        <ref bean="dataPacketBuilderService" />
        <ref bean="uploadService" />
      </list>
    </constructor-arg>
    <property name="validators">
      <list>
        <ref bean="sensorUploadUserNameValidator" />
        <ref bean="sensorUploadRequestTypeValidator" />
        <ref bean="sensorUploadPhoneVersionValidator" />
        <ref bean="sensorUploadProtocolVersionValidator" />
        <ref bean="sensorUploadJsonDataExistsValidator" />
        <ref bean="sensorUploadCampaignIdValidator" />
      </list>
    </property>
    <property name="postProcessingService">
      <ref bean="messageLoggerService" />
    </property>
    <property name="featureName"><value>sensor data upload</value></property>
  </bean>
  
  <!-- Authentication -->
  <bean id="sensorUploadAuthenticationService" class="edu.ucla.cens.awserver.service.AuthenticationService">
    <constructor-arg index="0">
      <ref bean="sensorUploadAuthenticationDao" />
    </constructor-arg>
    <constructor-arg index="1">
      <bean class="edu.ucla.cens.awserver.validator.json.FailedJsonRequestAnnotator">
        <constructor-arg index="0"> 
	      <bean class="edu.ucla.cens.awserver.domain.ErrorResponse">
	        <property name="code" value="0200" />
	        <property name="text" value="authentication failed" />
	      </bean>
	    </constructor-arg>
      </bean>
    </constructor-arg>
    <constructor-arg index="2">
      <bean class="edu.ucla.cens.awserver.validator.json.FailedJsonRequestAnnotator">
        <constructor-arg index="0">
          <bean class="edu.ucla.cens.awserver.domain.ErrorResponse">
            <property name="code" value="0201" />
            <property name="text" value="user not enabled for access" />
          </bean>
        </constructor-arg>
      </bean>
    </constructor-arg>
    <constructor-arg index="3">
      <bean class="edu.ucla.cens.awserver.validator.json.FailedJsonRequestAnnotator">
        <constructor-arg index="0">
          <bean class="edu.ucla.cens.awserver.domain.ErrorResponse">
            <property name="code" value="0202" />
            <property name="text" value="default password disallowed" />
          </bean>
        </constructor-arg>
      </bean>
    </constructor-arg>
    <constructor-arg index="4"><value>false</value></constructor-arg> <!--  toggle whether new accounts are allowed access -->
  </bean>
  
  <!-- Validate JSON syntax -->
  <bean id="jsonMessageSyntaxValidationService" class="edu.ucla.cens.awserver.service.JsonMessageSyntaxValidationService">
    <constructor-arg index="0">
      <bean class="edu.ucla.cens.awserver.validator.json.FailedJsonRequestAnnotator">
        <constructor-arg index="0">
          <bean class="edu.ucla.cens.awserver.domain.ErrorResponse">
          	<property name="code" value="0101" />
          	<property name="text" value="JSON syntax error" />
          </bean>
        </constructor-arg>
      </bean>
    </constructor-arg>   
  </bean>
 	
  <!-- Log request data to the file system -->	
  <bean id="messageLoggerService" class="edu.ucla.cens.awserver.service.MessageLoggerService" />
  
  <!-- Validate JSON content according to app business rules -->
  <bean id="jsonMessageContentValidationService" class="edu.ucla.cens.awserver.service.JsonMessageContentValidationService">
  	<constructor-arg index="0">
  	  <map>
  	    <entry>
  	      <key><value>mobility</value></key>
  	      <list>
  	        <ref bean="jsonMsgMobilitySubtypeValidator" />
  	      </list>
  	    </entry> 
  	    <entry>
  	      <key><value>prompt</value></key>
  	      <list>
  	        <ref bean="jsonMsgDateValidator" />
            <ref bean="jsonMsgTimeValidator" />
            <ref bean="jsonMsgTimezoneValidator" />
            <ref bean="jsonMsgLocationValidator" />
            <ref bean="jsonMsgLatitudeValidator" />
            <ref bean="jsonMsgLongitudeValidator" />
            <ref bean="jsonMsgPromptVersionIdValidator" />
            <ref bean="jsonMsgPromptGroupIdValidator" />
            <!--  the tags array is ignored because it is unused for now -->
            <ref bean="jsonMsgPromptResponsesExistValidator" />
            <ref bean="jsonMsgPromptResponsesValidator" />
  	      </list>
  	    </entry>
  	  </map>
  	</constructor-arg>
    <constructor-arg index="1"><ref bean="jsonMsgEmptyArrayAnnotator" /></constructor-arg>
    <constructor-arg index="2"><ref bean="jsonMsgIncorrectArrayAnnotator" /></constructor-arg>
  </bean>
  
  <bean id="jsonMsgEmptyArrayAnnotator" class="edu.ucla.cens.awserver.validator.json.FailedJsonRequestAnnotator">
    <constructor-arg index="0">
      <bean class="edu.ucla.cens.awserver.domain.ErrorResponse">
        <property name="code" value="0102" />
        <property name="text" value="no data in message" />
      </bean>
    </constructor-arg>   
  </bean>
   
  <bean id="jsonMsgIncorrectArrayAnnotator" class="edu.ucla.cens.awserver.validator.json.FailedJsonRequestAnnotator">
    <constructor-arg index="0">
      <bean class="edu.ucla.cens.awserver.domain.ErrorResponse">
        <property name="code" value="0103" />
        <property name="text" value="incorrect array entry (not a JSONObject)" />
      </bean>
    </constructor-arg>   
  </bean>
  
  <bean id="jsonMsgMobilitySubtypeValidator" class="edu.ucla.cens.awserver.validator.json.JsonMsgMobilitySubtypeValidator">
    <constructor-arg index="0">
      <bean class="edu.ucla.cens.awserver.validator.json.FailedJsonRequestAnnotator">
        <constructor-arg index="0">
           <bean class="edu.ucla.cens.awserver.domain.ErrorResponse">
          	<property name="code" value="0500" />
          	<property name="text" value="missing or invalid subtype" />
          </bean>
        </constructor-arg>
      </bean>
    </constructor-arg>
    <constructor-arg index="1">
      <map>
        <entry>
          <key><value>mode_only</value></key>
          <list>
            <ref bean="jsonMsgDateValidator" />
            <ref bean="jsonMsgTimeValidator" />
            <ref bean="jsonMsgTimezoneValidator" />
            <ref bean="jsonMsgLocationValidator" />
            <ref bean="jsonMsgLatitudeValidator" />
            <ref bean="jsonMsgLongitudeValidator" />
            <ref bean="jsonMsgModeOnlyModeValidator" />
          </list>
        </entry>
        <entry>
          <key><value>mode_features</value></key>
          <list>
            <ref bean="jsonMsgDateValidator" />
            <ref bean="jsonMsgTimeValidator" />
            <ref bean="jsonMsgTimezoneValidator" />
            <ref bean="jsonMsgLocationValidator" />
            <ref bean="jsonMsgLatitudeValidator" />
            <ref bean="jsonMsgLongitudeValidator" />
            <ref bean="jsonMsgFeaturesExistValidator" />
            <ref bean="jsonMsgModeFeaturesModeValidator" />
            <ref bean="jsonMsgModeFeaturesSpeedValidator" />
            <ref bean="jsonMsgModeFeaturesVarianceValidator" />
            <ref bean="jsonMsgModeFeaturesAverageValidator" />
            <ref bean="jsonMsgModeFeaturesFftArrayExistsValidator" />
            <ref bean="jsonMsgModeFeaturesFftArrayValuesValidator" />
          </list>
        </entry>
      </map>
    </constructor-arg>
  </bean>
  
  <bean id="jsonMsgDateValidator" class="edu.ucla.cens.awserver.validator.json.JsonMsgDateValidator">
    <constructor-arg index="0">
      <bean class="edu.ucla.cens.awserver.validator.json.FailedJsonRequestAnnotator">
        <constructor-arg index="0">
           <bean class="edu.ucla.cens.awserver.domain.ErrorResponse">
          	<property name="code" value="0400" />
          	<property name="text" value="missing or invalid date" />
          </bean>
        </constructor-arg>   
      </bean>
    </constructor-arg>
  </bean>
  
  <bean id="jsonMsgTimeValidator" class="edu.ucla.cens.awserver.validator.json.JsonMsgTimeValidator">
    <constructor-arg index="0">
      <bean class="edu.ucla.cens.awserver.validator.json.FailedJsonRequestAnnotator">
        <constructor-arg index="0">
          <bean class="edu.ucla.cens.awserver.domain.ErrorResponse">
          	<property name="code" value="0401" />
          	<property name="text" value="missing or invalid time" />
          </bean>
        </constructor-arg>  
      </bean>
    </constructor-arg>
  </bean>

  <bean id="jsonMsgTimezoneValidator" class="edu.ucla.cens.awserver.validator.json.JsonMsgTimezoneValidator">
    <constructor-arg index="0">
      <bean class="edu.ucla.cens.awserver.validator.json.FailedJsonRequestAnnotator">
        <constructor-arg index="0">
          <bean class="edu.ucla.cens.awserver.domain.ErrorResponse">
          	<property name="code" value="0402" />
          	<property name="text" value="missing or invalid timezone" />
          </bean>
        </constructor-arg>  
      </bean>
    </constructor-arg>
  </bean>

  <bean id="jsonMsgLocationValidator" class="edu.ucla.cens.awserver.validator.json.JsonMsgNamedObjectValidator">
    <constructor-arg index="0">
      <bean class="edu.ucla.cens.awserver.validator.json.FailedJsonRequestAnnotator">
        <constructor-arg index="0">
           <bean class="edu.ucla.cens.awserver.domain.ErrorResponse">
          	<property name="code" value="0403" />
          	<property name="text" value="missing or invalid location" />
          </bean>
        </constructor-arg>  
      </bean>
    </constructor-arg>
    <constructor-arg index="1">
      <value>location</value>
    </constructor-arg>
  </bean>

  <bean id="jsonMsgLatitudeValidator" class="edu.ucla.cens.awserver.validator.json.JsonMsgLatLongValidator">
    <constructor-arg index="0">
      <bean class="edu.ucla.cens.awserver.validator.json.FailedJsonRequestAnnotator">
        <constructor-arg index="0">
          <bean class="edu.ucla.cens.awserver.domain.ErrorResponse">
          	<property name="code" value="0404" />
          	<property name="text" value="missing or invalid latitude" />
          </bean>
        </constructor-arg>  
      </bean>
    </constructor-arg>
    <constructor-arg>
      <value>latitude</value>
    </constructor-arg>
  </bean>

  <bean id="jsonMsgLongitudeValidator" class="edu.ucla.cens.awserver.validator.json.JsonMsgLatLongValidator">
    <constructor-arg index="0">
      <bean class="edu.ucla.cens.awserver.validator.json.FailedJsonRequestAnnotator">
        <constructor-arg index="0">
          <bean class="edu.ucla.cens.awserver.domain.ErrorResponse">
          	<property name="code" value="0405" />
          	<property name="text" value="missing or invalid longitude" />
          </bean>
        </constructor-arg>  
      </bean>
    </constructor-arg>
    <constructor-arg>
      <value>longitude</value>
    </constructor-arg>
  </bean>

  <bean id="jsonMsgModeOnlyModeValidator" class="edu.ucla.cens.awserver.validator.json.JsonMsgMobilityModeValidator">
    <constructor-arg index="0">
      <bean class="edu.ucla.cens.awserver.validator.json.FailedJsonRequestAnnotator">
        <constructor-arg index="0">
          <bean class="edu.ucla.cens.awserver.domain.ErrorResponse">
          	<property name="code" value="0501" />
          	<property name="text" value="missing or invalid mode in mode_only message" />
          </bean>
        </constructor-arg>  
      </bean>
    </constructor-arg>
    <constructor-arg index="1">
      <list>
        <value>still</value>
        <value>walk</value>
        <value>run</value>
        <value>bike</value>
        <value>drive</value>
      </list>
    </constructor-arg>
    <constructor-arg index="2">
      <value>false</value>
    </constructor-arg>
  </bean>

  <bean id="jsonMsgFeaturesExistValidator" class="edu.ucla.cens.awserver.validator.json.JsonMsgNamedObjectValidator">
    <constructor-arg index="0">
      <bean class="edu.ucla.cens.awserver.validator.json.FailedJsonRequestAnnotator">
        <constructor-arg index="0">
          <bean class="edu.ucla.cens.awserver.domain.ErrorResponse">
          	<property name="code" value="0506" />
          	<property name="text" value="missing or invalid features" />
          </bean>
        </constructor-arg>  
      </bean>
    </constructor-arg>
    <constructor-arg index="1">
      <value>features</value>
    </constructor-arg>
  </bean>
  
    <bean id="jsonMsgModeFeaturesModeValidator" class="edu.ucla.cens.awserver.validator.json.JsonMsgMobilityModeValidator">
    <constructor-arg index="0">
      <bean class="edu.ucla.cens.awserver.validator.json.FailedJsonRequestAnnotator">
        <constructor-arg index="0">
          <bean class="edu.ucla.cens.awserver.domain.ErrorResponse">
          	<property name="code" value="0501" />
          	<property name="text" value="missing or invalid mode in mode_features message" />
          </bean>
        </constructor-arg>  
      </bean>
    </constructor-arg>
    <constructor-arg index="1">
      <list>
        <value>still</value>
        <value>walk</value>
        <value>run</value>
        <value>bike</value>
        <value>drive</value>
      </list>
    </constructor-arg>
    <constructor-arg index="2">
      <value>true</value>
    </constructor-arg>
  </bean>
  
  <bean id="jsonMsgModeFeaturesSpeedValidator" class="edu.ucla.cens.awserver.validator.json.JsonMsgFeaturesDoubleValidator">
    <constructor-arg index="0">
      <bean class="edu.ucla.cens.awserver.validator.json.FailedJsonRequestAnnotator">
        <constructor-arg index="0">
          <bean class="edu.ucla.cens.awserver.domain.ErrorResponse">
          	<property name="code" value="0502" />
          	<property name="text" value="missing or invalid speed in mode_features message" />
          </bean>
        </constructor-arg>  
      </bean>
    </constructor-arg>
    <constructor-arg index="1">
      <value>speed</value>
    </constructor-arg>
  </bean>

  <bean id="jsonMsgModeFeaturesVarianceValidator" class="edu.ucla.cens.awserver.validator.json.JsonMsgFeaturesDoubleValidator">
    <constructor-arg index="0">
      <bean class="edu.ucla.cens.awserver.validator.json.FailedJsonRequestAnnotator">
        <constructor-arg index="0">
          <bean class="edu.ucla.cens.awserver.domain.ErrorResponse">
          	<property name="code" value="0503" />
          	<property name="text" value="missing or invalid variance in mode_features message" />
          </bean>
        </constructor-arg>  
      </bean>
    </constructor-arg>
    <constructor-arg index="1">
      <value>variance</value>
    </constructor-arg>
  </bean>

  <bean id="jsonMsgModeFeaturesAverageValidator" class="edu.ucla.cens.awserver.validator.json.JsonMsgFeaturesDoubleValidator">
    <constructor-arg index="0">
      <bean class="edu.ucla.cens.awserver.validator.json.FailedJsonRequestAnnotator">
        <constructor-arg index="0">
          <bean class="edu.ucla.cens.awserver.domain.ErrorResponse">
          	<property name="code" value="0504" />
          	<property name="text" value="missing or invalid average in mode_features message" />
          </bean>
        </constructor-arg>  
      </bean>
    </constructor-arg>
    <constructor-arg index="1">
      <value>average</value>
    </constructor-arg>
  </bean>

  <bean id="jsonMsgModeFeaturesFftArrayExistsValidator" class="edu.ucla.cens.awserver.validator.json.JsonMsgFeaturesFftArrayExistsValidator">
    <constructor-arg index="0">
      <bean class="edu.ucla.cens.awserver.validator.json.FailedJsonRequestAnnotator">
        <constructor-arg index="0">
          <bean class="edu.ucla.cens.awserver.domain.ErrorResponse">
          	<property name="code" value="0505" />
          	<property name="text" value="missing or invalid fft array in mode_features message" />
          </bean>
        </constructor-arg>  
      </bean>
    </constructor-arg>
  </bean>

  <bean id="jsonMsgModeFeaturesFftArrayValuesValidator" class="edu.ucla.cens.awserver.validator.json.JsonMsgFeaturesFftArrayValuesValidator">
    <constructor-arg index="0">
      <bean class="edu.ucla.cens.awserver.validator.json.FailedJsonRequestAnnotator">
        <constructor-arg index="0">
          <bean class="edu.ucla.cens.awserver.domain.ErrorResponse">
          	<property name="code" value="0505" />
          	<property name="text" value="invalid fft array in mode_features message" />
          </bean>
        </constructor-arg>  
      </bean>
    </constructor-arg>
  </bean>
  
  <bean id="jsonMsgPromptVersionIdValidator" class="edu.ucla.cens.awserver.validator.json.JsonMsgPromptVersionIdValidator">
    <constructor-arg index="0">
      <bean class="edu.ucla.cens.awserver.validator.json.FailedJsonRequestAnnotator">
        <constructor-arg index="0">
          <bean class="edu.ucla.cens.awserver.domain.ErrorResponse">
          	<property name="code" value="0600" />
          	<property name="text" value="invalid version_id in prompt message" />
          </bean>
        </constructor-arg>  
      </bean>
    </constructor-arg>
    <constructor-arg index="1">
      <ref bean="promptVersionIdDao" />
    </constructor-arg>
  </bean>

  <bean id="promptVersionIdDao" class="edu.ucla.cens.awserver.dao.PromptVersionIdDao">
    <constructor-arg index="0"><ref bean="dataSource" /></constructor-arg>
  </bean>

  <bean id="jsonMsgPromptGroupIdValidator" class="edu.ucla.cens.awserver.validator.json.JsonMsgPromptGroupIdValidator">
    <constructor-arg index="0">
      <bean class="edu.ucla.cens.awserver.validator.json.FailedJsonRequestAnnotator">
        <constructor-arg index="0">
          <bean class="edu.ucla.cens.awserver.domain.ErrorResponse">
          	<property name="code" value="0601" />
          	<property name="text" value="invalid group_id in prompt message" />
          </bean>
        </constructor-arg>  
      </bean>
    </constructor-arg>
    <constructor-arg index="1">
      <ref bean="promptGroupIdDao" />
    </constructor-arg>
  </bean>

  <bean id="promptGroupIdDao" class="edu.ucla.cens.awserver.dao.PromptGroupIdDao">
    <constructor-arg index="0"><ref bean="dataSource" /></constructor-arg>
  </bean>
  
  <bean id="jsonMsgPromptResponsesExistValidator" class="edu.ucla.cens.awserver.validator.json.JsonMsgPromptResponsesExistValidator">
    <constructor-arg index="0">
      <bean class="edu.ucla.cens.awserver.validator.json.FailedJsonRequestAnnotator">
        <constructor-arg index="0">
          <bean class="edu.ucla.cens.awserver.domain.ErrorResponse">
          	<property name="code" value="0602" />
          	<property name="text" value="missing responses in prompt message" />
          </bean>
        </constructor-arg>  
      </bean>
    </constructor-arg>
  </bean>
  
  <bean id="jsonMsgPromptResponsesValidator" class="edu.ucla.cens.awserver.validator.json.JsonMsgPromptResponsesValidator">
    <constructor-arg index="0">
      <bean class="edu.ucla.cens.awserver.validator.json.FailedJsonRequestAnnotator">
        <constructor-arg index="0">
          <bean class="edu.ucla.cens.awserver.domain.ErrorResponse">
          	<property name="code" value="0603" />
          	<property name="text" value="invalid prompt response" />
          </bean>
        </constructor-arg>  
      </bean>
    </constructor-arg>
    <constructor-arg index="1">
      <ref bean="promptResponseGroupDao" />
    </constructor-arg>
  </bean>

  <bean id="promptResponseGroupDao" class="edu.ucla.cens.awserver.dao.PromptResponseGroupDao">
    <constructor-arg index="0"><ref bean="dataSource" /></constructor-arg>
  </bean>
  
   <bean id="dataPacketBuilderService" class="edu.ucla.cens.awserver.service.DataPacketBuilderService">
    <constructor-arg index="0">
      <map>
        <entry>
          <key><value>mobility-mode_only</value></key>
          <bean class="edu.ucla.cens.awserver.domain.MobilityModeOnlyDataPacketBuilder" />
        </entry>
         <entry>
          <key><value>mobility-mode_features</value></key>
          <bean class="edu.ucla.cens.awserver.domain.MobilityModeFeaturesDataPacketBuilder"></bean>
        </entry>
        <entry>
          <key><value>prompt</value></key>
          <bean class="edu.ucla.cens.awserver.domain.PromptDataPacketBuilder"></bean>
        </entry>
      </map>
    </constructor-arg>   
  </bean>
  
  <bean id="uploadService" class="edu.ucla.cens.awserver.service.UploadService" >
  	<constructor-arg index="0">
      <map>
        <entry>
          <key><value>mobility</value></key>
          <bean class="edu.ucla.cens.awserver.dao.MobilityUploadDao">
            <constructor-arg index="0"><ref bean="dataSource" /></constructor-arg>
          </bean>
        </entry>
        <entry>
          <key><value>prompt</value></key>
          <bean class="edu.ucla.cens.awserver.dao.PromptUploadDao">
            <constructor-arg index="0"><ref bean="dataSource" /></constructor-arg>
          </bean>
        </entry>
      </map>
    </constructor-arg>
  </bean>
  
   <!-- Interact with database -->
  <bean id="sensorUploadAuthenticationDao" class="edu.ucla.cens.awserver.dao.AuthenticationDao">
    <constructor-arg index="0"><ref bean="dataSource" /></constructor-arg>
    <constructor-arg index="1"><null /></constructor-arg>
    <constructor-arg index="2"><value>false</value></constructor-arg>
  </bean>
  
</beans>